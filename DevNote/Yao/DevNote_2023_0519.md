# DevNote 2023.05.19 双目渲染

## 简述

本次更新主要实现双目渲染功能。需求是能在编辑器和播放器中使用双目全景图或者双目全景视频。全景图格式为上下格式或者左右格式拼接的8k图片或视频。

## 技术方案

### 双目渲染

修改原本的天空盒使用：原本使用全局天空盒，此处应改为使用相机天空盒（为相机增加天空盒组件）

### 分割双目全景图或视频

无需特殊操作分割全景图片，创建sprite的时候选择区域即可

对于视频的分割，有三个方案：Shader/Compute Shader（技术不允许）、Graphics裁剪材质（性能不达标）和FFmpeg+同步播放（最终选定方案）
FFmpeg + 同步播放需要使用FFmpeg工具将视频切分成两个视频，再由两个VideoPlayer同步播放到两个摄像机的天空盒中。


##  需求简析

需要实现编辑器和播放器的双目渲染功能，需要对如下功能实现或修改:

### 全景资源数据格式修改

**编辑器**和**播放器端**同时实现：

1. 无论全景图或是视频都存在PanoView中，可在Panoview中加入两个字段来标记全景图：
    1. 是否为全景图：布尔值
    2. 拼接格式：新建一个枚举类

### 全景资源读写格式：

<<<<<<< HEAD
任何导入的资源一旦被用户标记为全景。其读取路径会有所改变：原路径文件变为左眼资源，同时生成一个名为“ ***原文件名__R*** ”（注：双下划线）的文件，用于存放右眼资源。因此：
=======
任何导入的资源一旦被用户标记为全景。其读取路径会有所改变：原路径文件变为左眼资源，同时生成一个名为“*<原文件名>__R*”（注：双下划线）的文件，用于存放右眼资源。因此：
>>>>>>> 1551c5c8493d808176d3d15aea3ee17d08996b73

在**编辑器**中：资源的使用和原来相同

在**播放器**中：修改DefaultPath，当资源为全景资源时，分别读取两个不同路径


### 双目全景资源的标记（低优先级）

在**编辑器**中：
1. 为场景（PanoScene）的编辑面板（SceneEditorScript）增加一个“全景资源格式设置”的功能。当选择格式后，当即进行资源的分割
    1. 如果用户试图改回单目资源，则保留双目的资源文件，但是显示时，仅显示原来格式文件
2. 在资源面板（ResourcePanel）的资源显示单元中（ResourceCellScript）中为双目资源增加标记：右上角添加一个“**3D**”的字样

在**播放器**中：无需修改

### 视频的双目渲染
**编辑器**端： 无需做出任何修改

**播放器**端，需要修改PlayerManager：
1. 增加一个副VideoPlayer，并实现同步播放功能
2. 当场景资源是双目时，使用两个VideoPlayer同步播放

### 全景资源的转换

在**编辑器**中：
1. 需要用FFmpeg 工具。标记资源后立刻进行分割
2. 使用进度条和回调函数显示转码进度

在**播放器**中：无需修改

## 事项清单

编辑器中：
<<<<<<< HEAD
<<<<<<< HEAD
1. [x] 全景图的数据格式修改：
    1. 增加是否为双目字段
    2. 新建枚举类，标记双目资源格式
2. [x] 全景资源读写：在DefaultPath中增加双目视频的读写路径。原路径文件变为左眼资源，同时生成一个名为“***原文件名__R***”（注：双下划线）的文件，用于存放右眼资源。
3. [ ] 前端标记功能：
    1. 在SceneEditorScript中增加选择视频单双目及其格式的区域，其包含：单双目选择按钮（单选按钮）、格式选择（下拉框）、转换按键（按钮）
    2. 修改ResourceCellScript，如果标记为双目资源，不论场景中如何使用，增加**3D**角标
    3. （可选）修改场景显示单元（SceneScript），如果为双目场景，增加**3D**角标
4. [ ] 集成FFmpeg：
=======
1. [] 全景图的数据格式修改：
=======
1. [x] 全景图的数据格式修改：
>>>>>>> f2f8627aa21b544357ffdc6979d830f5c888eae1
    1. 增加是否为双目字段
    2. 新建枚举类，标记双目资源格式
2. [x] 全景资源读写：在DefaultPath中增加双目视频的读写路径
3. [ ] 前端标记功能：
    1. 在SceneEditorScript中增加选择视频单双目及其格式的区域，其包含：单双目选择按钮（单选按钮）、格式选择（下拉框）、转换按键（按钮）
    2. 修改ResourceCellScript，如果标记为双目资源，不论场景中如何使用，增加**3D**角标
    3. （可选）修改场景显示单元（SceneScript），如果为双目场景，增加**3D**角标
<<<<<<< HEAD
4. [] 集成FFmpeg：
>>>>>>> 1551c5c8493d808176d3d15aea3ee17d08996b73
=======
4. [ ] 集成FFmpeg：
>>>>>>> f2f8627aa21b544357ffdc6979d830f5c888eae1
    1. 集成FFmpeg工具，使其全景资源在标记时被调用
    2. 使用进图条通知用户视频分割进度

播放器：
<<<<<<< HEAD
<<<<<<< HEAD
1. [x] 全景图的数据格式修改：（同编辑器）
    1. 增加是否为双目字段
    2. 新建枚举类，标记双目资源格式
2. [x] 全景资源读写：在DefaultPath中增加双目视频的读写路径(同编辑器)
3. [ ] 双目渲染功能：
    1. [ ] 对图片，创建Sprite时进行分割
    2. [x] 对视频，在修改PlayerManager的播放函数，实现双Player同步播放功能
    3. [x] 创建CamRenderer类，封装双目/单目方法及天空盒

## 排查笔记

在本次迭代中，遇到如下问题：

### 已解决

1. 锚点放置反向
描述：刚刚放下锚点时候，锚点面向外面而不是相机。
解决方法：修改AnchorSurfaceManager代码，在createNewAnchor中。放下锚点时，使用AnchorScript.lookAtCam调整方向，而不是直接操作AnchorScript的transform


### 未解决

1. 初始镜头滑动预览跳变
    + 描述：在预览模式下，当设置的镜头切入角度和初始不符时，第一次移动镜头会发生跳变。
    + 可用信息：
        1. 经测试发现，预览模式下试图第一次拖动镜头时，相机的旋转坐标会变成（0，0，0）
        2. 建议检查MouseController内的代码
=======
1. [] 全景图的数据格式修改：
=======
1. [x] 全景图的数据格式修改：
>>>>>>> f2f8627aa21b544357ffdc6979d830f5c888eae1
    1. 增加是否为双目字段
    2. 新建枚举类，标记双目资源格式
2. [x] 全景资源读写：在DefaultPath中增加双目视频的读写路径
3. [ ] 双目渲染功能：
    1. 对图片，创建Sprite时进行分割
    2. 对视频，在修改PlayerManager的播放函数，实现双Player同步播放功能
<<<<<<< HEAD
>>>>>>> 1551c5c8493d808176d3d15aea3ee17d08996b73
=======
>>>>>>> f2f8627aa21b544357ffdc6979d830f5c888eae1
